<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Completo - FLAC + WaveSurfer</title>
    <script src="https://unpkg.com/wavesurfer.js@7.7.5"></script>
    <style>
        body { 
            background-color: #121212; 
            color: #fff; 
            font-family: 'Segoe UI', sans-serif; 
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 { color: #1DB954; margin-bottom: 5px; }
        h2 { color: #1DB954; font-size: 1.2em; margin-top: 30px; }
        .subtitle { color: #888; margin-bottom: 30px; }
        
        .test-section {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        #waveform { 
            border: 1px solid #333; 
            height: 128px; 
            margin: 15px 0;
            background-color: #0a0a0a;
        }
        
        button { 
            padding: 12px 24px; 
            font-size: 1em;
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
            font-weight: 600;
        }
        button:hover:not(:disabled) { 
            opacity: 0.8; 
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .status { 
            margin: 10px 0;
            padding: 12px;
            background-color: #2a2a2a;
            border-radius: 5px;
            font-size: 0.9em;
            border-left: 3px solid #555;
        }
        .status.info { border-left-color: #3b82f6; }
        .status.success { border-left-color: #1DB954; }
        .status.error { border-left-color: #ef4444; }
        .status.warning { border-left-color: #f59e0b; }
        
        .url-list {
            background-color: #0a0a0a;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .url-item {
            padding: 10px;
            margin: 8px 0;
            background-color: #1e1e1e;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            border-left: 3px solid #555;
            transition: all 0.3s;
        }
        .url-item.checking { 
            border-left-color: #3b82f6; 
            background-color: #1a2332;
        }
        .url-item.exists { 
            border-left-color: #1DB954; 
            background-color: #1a2e1e;
        }
        .url-item.notfound { 
            border-left-color: #ef4444; 
            background-color: #2e1a1a;
        }
        .url-item.cors-error { 
            border-left-color: #f59e0b; 
            background-color: #2e2a1a;
        }
        
        .audio-player {
            margin: 15px 0;
            width: 100%;
        }
        
        code {
            background-color: #0a0a0a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #1DB954;
        }
        
        .log {
            background-color: #0a0a0a;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            padding: 2px 0;
            color: #aaa;
        }
        .log-entry.error { color: #ef4444; }
        .log-entry.success { color: #1DB954; }
        .log-entry.info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>üî¨ Test Completo - FLAC + WaveSurfer</h1>
    <p class="subtitle">Diagn√≥stico completo para encontrar por qu√© no carga el audio</p>

    <!-- TEST 1: Verificar existencia del archivo -->
    <div class="test-section">
        <h2>üìã Test 1: Verificar si el archivo existe</h2>
        <p>Comprobando si el archivo FLAC est√° accesible sin reproducirlo...</p>
        <button id="testExistenceBtn">üîç Verificar existencia de archivos</button>
        <div class="url-list" id="existenceResults"></div>
        <div id="existenceStatus" class="status info">
            Haz clic en el bot√≥n para verificar si los archivos existen
        </div>
    </div>

    <!-- TEST 2: Audio HTML5 nativo -->
    <div class="test-section">
        <h2>üéµ Test 2: Reproductor HTML5 nativo</h2>
        <p>Probando con <code>&lt;audio&gt;</code> tag de HTML5 (sin WaveSurfer):</p>
        <select id="audioUrlSelect" style="width: 100%; padding: 10px; background: #2a2a2a; color: white; border: 1px solid #444; border-radius: 5px; margin: 10px 0;">
            <option value="">Selecciona una URL para probar...</option>
        </select>
        <audio id="nativeAudio" controls class="audio-player"></audio>
        <div id="nativeStatus" class="status info">
            Selecciona una URL del men√∫ desplegable
        </div>
    </div>

    <!-- TEST 3: WaveSurfer -->
    <div class="test-section">
        <h2>üåä Test 3: WaveSurfer.js</h2>
        <p>Probando con la librer√≠a WaveSurfer:</p>
        <button id="testWavesurferBtn">üåä Probar con WaveSurfer</button>
        <div id="waveform"></div>
        <button id="playPauseBtn" disabled>‚è∏Ô∏è Pausa</button>
        <div id="wavesurferStatus" class="status info">
            Primero verifica que el archivo exista (Test 1)
        </div>
    </div>

    <!-- LOG -->
    <div class="test-section">
        <h2>üìù Log de eventos</h2>
        <div id="logContainer" class="log"></div>
    </div>

    <script>
        const existenceResults = document.getElementById('existenceResults');
        const existenceStatus = document.getElementById('existenceStatus');
        const nativeAudio = document.getElementById('nativeAudio');
        const audioUrlSelect = document.getElementById('audioUrlSelect');
        const nativeStatus = document.getElementById('nativeStatus');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const wavesurferStatus = document.getElementById('wavesurferStatus');
        const logContainer = document.getElementById('logContainer');
        
        let wavesurfer = null;
        let workingUrl = null;

        // URLs a probar
        const audioUrls = [
            {
                name: "GitHub Pages - Espacios normales",
                url: "https://vloitz.github.io/wav-sets/audio/Jungle Rhythmic Grooves 004.flac"
            },
            {
                name: "GitHub Pages - %20",
                url: "https://vloitz.github.io/wav-sets/audio/Jungle%20Rhythmic%20Grooves%20004.flac"
            },
            {
                name: "GitHub Pages - Plus (+)",
                url: "https://vloitz.github.io/wav-sets/audio/Jungle+Rhythmic+Grooves+004.flac"
            },
            {
                name: "GitHub Raw - main",
                url: "https://raw.githubusercontent.com/vloitz/wav-sets/main/audio/Jungle Rhythmic Grooves 004.flac"
            },
            {
                name: "GitHub Raw - %20",
                url: "https://raw.githubusercontent.com/vloitz/wav-sets/main/audio/Jungle%20Rhythmic%20Grooves%20004.flac"
            }
        ];

        // Funci√≥n de logging
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
        }

        // TEST 1: Verificar existencia
        async function checkFileExistence(urlObj, index) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'url-item checking';
            itemDiv.id = `url-${index}`;
            itemDiv.innerHTML = `
                <strong>${index + 1}. ${urlObj.name}</strong><br>
                <small>${urlObj.url}</small><br>
                <em style="color: #3b82f6;">üîç Verificando...</em>
            `;
            existenceResults.appendChild(itemDiv);

            log(`Verificando: ${urlObj.name}`, 'info');

            try {
                const response = await fetch(urlObj.url, { method: 'HEAD' });
                
                if (response.ok) {
                    itemDiv.className = 'url-item exists';
                    itemDiv.innerHTML = `
                        <strong>${index + 1}. ${urlObj.name}</strong><br>
                        <small>${urlObj.url}</small><br>
                        <em style="color: #1DB954;">‚úÖ Archivo existe (${response.status}) - Tama√±o: ${response.headers.get('content-length') ? (response.headers.get('content-length') / 1024 / 1024).toFixed(2) + ' MB' : 'desconocido'}</em>
                    `;
                    log(`‚úÖ ${urlObj.name} - Archivo existe`, 'success');
                    
                    // Agregar al select
                    const option = document.createElement('option');
                    option.value = urlObj.url;
                    option.textContent = `${urlObj.name} ‚úÖ`;
                    audioUrlSelect.appendChild(option);
                    
                    if (!workingUrl) workingUrl = urlObj.url;
                    return true;
                } else {
                    itemDiv.className = 'url-item notfound';
                    itemDiv.innerHTML = `
                        <strong>${index + 1}. ${urlObj.name}</strong><br>
                        <small>${urlObj.url}</small><br>
                        <em style="color: #ef4444;">‚ùå Error ${response.status}: ${response.statusText}</em>
                    `;
                    log(`‚ùå ${urlObj.name} - Error ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                itemDiv.className = 'url-item cors-error';
                itemDiv.innerHTML = `
                    <strong>${index + 1}. ${urlObj.name}</strong><br>
                    <small>${urlObj.url}</small><br>
                    <em style="color: #f59e0b;">‚ö†Ô∏è Error: ${error.message}</em>
                `;
                log(`‚ö†Ô∏è ${urlObj.name} - ${error.message}`, 'error');
                return false;
            }
        }

        // TEST 2: Audio nativo
        audioUrlSelect.addEventListener('change', () => {
            const url = audioUrlSelect.value;
            if (!url) return;
            
            nativeAudio.src = url;
            nativeStatus.className = 'status info';
            nativeStatus.textContent = `‚è≥ Cargando desde: ${audioUrls.find(u => u.url === url)?.name}`;
            log(`Cargando en audio nativo: ${url}`, 'info');
            
            nativeAudio.load();
        });

        nativeAudio.addEventListener('loadeddata', () => {
            nativeStatus.className = 'status success';
            nativeStatus.textContent = `‚úÖ ¬°Audio cargado! Duraci√≥n: ${Math.floor(nativeAudio.duration / 60)}:${Math.floor(nativeAudio.duration % 60).toString().padStart(2, '0')}`;
            log('‚úÖ Audio HTML5 cargado correctamente', 'success');
        });

        nativeAudio.addEventListener('error', (e) => {
            nativeStatus.className = 'status error';
            nativeStatus.textContent = `‚ùå Error al cargar audio: ${nativeAudio.error?.message || 'desconocido'}`;
            log(`‚ùå Error en audio nativo: ${nativeAudio.error?.message}`, 'error');
        });

        // TEST 3: WaveSurfer
        document.getElementById('testWavesurferBtn').addEventListener('click', () => {
            if (!workingUrl) {
                wavesurferStatus.className = 'status error';
                wavesurferStatus.textContent = '‚ùå Primero verifica que al menos una URL funcione (Test 1)';
                return;
            }

            log(`Iniciando WaveSurfer con: ${workingUrl}`, 'info');
            wavesurferStatus.className = 'status info';
            wavesurferStatus.textContent = '‚è≥ Inicializando WaveSurfer...';

            if (wavesurfer) wavesurfer.destroy();

            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#555',
                progressColor: '#1DB954',
                height: 128,
                cursorWidth: 2,
                cursorColor: '#fff',
                barWidth: 3,
                barGap: 2,
                responsive: true,
                normalize: true
            });

            wavesurfer.on('loading', (percent) => {
                wavesurferStatus.className = 'status info';
                wavesurferStatus.textContent = `‚è≥ Cargando waveform: ${percent}%`;
                log(`Cargando waveform: ${percent}%`, 'info');
            });

            wavesurfer.on('ready', () => {
                const duration = wavesurfer.getDuration();
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                wavesurferStatus.className = 'status success';
                wavesurferStatus.textContent = `‚úÖ ¬°WaveSurfer listo! Duraci√≥n: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                playPauseBtn.disabled = false;
                playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
                log('‚úÖ WaveSurfer cargado exitosamente', 'success');
            });

            wavesurfer.on('error', (err) => {
                wavesurferStatus.className = 'status error';
                wavesurferStatus.textContent = `‚ùå Error WaveSurfer: ${err}`;
                log(`‚ùå Error WaveSurfer: ${err}`, 'error');
            });

            wavesurfer.on('play', () => playPauseBtn.textContent = '‚è∏Ô∏è Pause');
            wavesurfer.on('pause', () => playPauseBtn.textContent = '‚ñ∂Ô∏è Play');

            wavesurfer.load(workingUrl);
        });

        playPauseBtn.addEventListener('click', () => {
            if (wavesurfer) wavesurfer.playPause();
        });

        // Bot√≥n Test 1
        document.getElementById('testExistenceBtn').addEventListener('click', async () => {
            existenceResults.innerHTML = '';
            existenceStatus.className = 'status info';
            existenceStatus.textContent = 'üîç Verificando archivos...';
            workingUrl = null;
            audioUrlSelect.innerHTML = '<option value="">Selecciona una URL para probar...</option>';
            
            log('=== Iniciando Test 1: Verificaci√≥n de existencia ===', 'info');

            let foundAny = false;
            for (let i = 0; i < audioUrls.length; i++) {
                const exists = await checkFileExistence(audioUrls[i], i);
                if (exists) foundAny = true;
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            if (foundAny) {
                existenceStatus.className = 'status success';
                existenceStatus.textContent = '‚úÖ Se encontr√≥ al menos una URL v√°lida. Prueba el Test 2 (Audio HTML5).';
                log('=== Test 1 completado: URLs v√°lidas encontradas ===', 'success');
            } else {
                existenceStatus.className = 'status error';
                existenceStatus.textContent = '‚ùå Ning√∫n archivo fue encontrado. Verifica que el archivo est√© subido a GitHub y que GitHub Pages est√© activo.';
                log('=== Test 1 completado: No se encontraron URLs v√°lidas ===', 'error');
            }
        });

        // Auto-start Test 1
        log('P√°gina cargada - Lista para tests', 'info');
    </script>
</body>
</html>
